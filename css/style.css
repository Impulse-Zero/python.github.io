// Exercises Management System
class ExercisesManager {
    constructor() {
        this.exercises = this.getExercisesData();
        this.userProgress = this.loadUserProgress();
        this.currentExercise = null;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.updateStats();
        this.renderExercises();
        this.setupFilters();
    }

    getExercisesData() {
        return {
            1: {
                id: 1,
                title: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä",
                description: "–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–≤–∞ —á–∏—Å–ª–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏—é (+, -, *, /), –∑–∞—Ç–µ–º –≤—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
                difficulty: "easy",
                category: "basics",
                examples: [
                    "–í—Ö–æ–¥: 5, 3, '+' ‚Üí –í—ã—Ö–æ–¥: 8",
                    "–í—Ö–æ–¥: 10, 2, '*' ‚Üí –í—ã—Ö–æ–¥: 20",
                    "–í—Ö–æ–¥: 8, 4, '/' ‚Üí –í—ã—Ö–æ–¥: 2.0"
                ],
                starterCode: `def calculator(a, b, operation):
    # –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å
    pass

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
print(calculator(5, 3, '+'))  # –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ 8
print(calculator(10, 2, '*')) # –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ 20
print(calculator(8, 4, '/'))  # –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ 2.0`,
                solution: `def calculator(a, b, operation):
    if operation == '+':
        return a + b
    elif operation == '-':
        return a - b
    elif operation == '*':
        return a * b
    elif operation == '/':
        return a / b if b != 0 else "–û—à–∏–±–∫–∞: –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å"
    else:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è"`,
                hints: [
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—Å–ª–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã if/elif/else",
                    "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å",
                    "–í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –ø–æ–º–æ—â—å—é return"
                ],
                tests: [
                    { input: [5, 3, '+'], expected: 8 },
                    { input: [10, 2, '*'], expected: 20 },
                    { input: [8, 4, '/'], expected: 2.0 },
                    { input: [5, 0, '/'], expected: "–û—à–∏–±–∫–∞: –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å" }
                ]
            },
            2: {
                id: 2,
                title: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ç–Ω–æ—Å—Ç–∏",
                description: "–ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∏—Å–ª–æ —á–µ—Ç–Ω—ã–º –∏–ª–∏ –Ω–µ—á–µ—Ç–Ω—ã–º.",
                difficulty: "easy",
                category: "functions",
                examples: [
                    "–í—Ö–æ–¥: 4 ‚Üí –í—ã—Ö–æ–¥: '–ß–µ—Ç–Ω–æ–µ'",
                    "–í—Ö–æ–¥: 7 ‚Üí –í—ã—Ö–æ–¥: '–ù–µ—á–µ—Ç–Ω–æ–µ'",
                    "–í—Ö–æ–¥: 0 ‚Üí –í—ã—Ö–æ–¥: '–ß–µ—Ç–Ω–æ–µ'"
                ],
                starterCode: `def check_even_odd(number):
    # –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å
    pass

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
print(check_even_odd(4))  # –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ '–ß–µ—Ç–Ω–æ–µ'
print(check_even_odd(7))  # –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ '–ù–µ—á–µ—Ç–Ω–æ–µ'
print(check_even_odd(0))  # –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ '–ß–µ—Ç–Ω–æ–µ'`,
                solution: `def check_even_odd(number):
    if number % 2 == 0:
        return "–ß–µ—Ç–Ω–æ–µ"
    else:
        return "–ù–µ—á–µ—Ç–Ω–æ–µ"`,
                hints: [
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä % –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è",
                    "–ï—Å–ª–∏ —á–∏—Å–ª–æ % 2 —Ä–∞–≤–Ω–æ 0, —Ç–æ —á–∏—Å–ª–æ —á–µ—Ç–Ω–æ–µ",
                    "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç—Ä–æ–∫–∏ '–ß–µ—Ç–Ω–æ–µ' –∏–ª–∏ '–ù–µ—á–µ—Ç–Ω–æ–µ'"
                ],
                tests: [
                    { input: [4], expected: "–ß–µ—Ç–Ω–æ–µ" },
                    { input: [7], expected: "–ù–µ—á–µ—Ç–Ω–æ–µ" },
                    { input: [0], expected: "–ß–µ—Ç–Ω–æ–µ" },
                    { input: [-2], expected: "–ß–µ—Ç–Ω–æ–µ" }
                ]
            },
            // ... –¥—Ä—É–≥–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        };
    }

    loadUserProgress() {
        const saved = localStorage.getItem('pythonExercisesProgress');
        return saved ? JSON.parse(saved) : {
            solved: [],
            attempts: {},
            hintsUsed: {},
            currentStreak: 0,
            lastSolved: null
        };
    }

    saveUserProgress() {
        localStorage.setItem('pythonExercisesProgress', JSON.stringify(this.userProgress));
    }

    setupEventListeners() {
        // Exercise buttons
        document.querySelectorAll('.start-exercise').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const exerciseId = parseInt(e.target.dataset.exercise);
                this.openExercise(exerciseId);
            });
        });

        // Modal events
        this.setupModalEvents();

        // Exercise editor events
        document.getElementById('runExerciseBtn').addEventListener('click', () => this.runExercise());
        document.getElementById('resetExerciseBtn').addEventListener('click', () => this.resetExercise());
        document.getElementById('hintExerciseBtn').addEventListener('click', () => this.showHint());
        document.getElementById('testExerciseBtn').addEventListener('click', () => this.testExercise());
    }

    setupFilters() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const difficulty = e.target.dataset.difficulty;
                
                // Update active button
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                this.filterExercises(difficulty);
            });
        });
    }

    filterExercises(difficulty) {
        const exercises = document.querySelectorAll('.exercise-card');
        
        exercises.forEach(exercise => {
            if (difficulty === 'all' || exercise.dataset.difficulty === difficulty) {
                exercise.style.display = 'block';
            } else {
                exercise.style.display = 'none';
            }
        });
    }

    renderExercises() {
        // Update exercise cards based on user progress
        Object.values(this.exercises).forEach(exercise => {
            const exerciseElement = document.querySelector(`[data-exercise="${exercise.id}"]`);
            if (exerciseElement) {
                const isSolved = this.userProgress.solved.includes(exercise.id);
                
                if (isSolved) {
                    exerciseElement.innerHTML = '‚úÖ –†–µ—à–µ–Ω–æ';
                    exerciseElement.classList.add('solved');
                }
            }
        });
    }

    openExercise(exerciseId) {
        this.currentExercise = this.exercises[exerciseId];
        
        if (!this.currentExercise) return;

        // Update modal content
        document.getElementById('modalExerciseTitle').textContent = 
            `${this.currentExercise.title} (#${String(exerciseId).padStart(3, '0')})`;
        
        document.getElementById('modalExerciseDescription').textContent = 
            this.currentExercise.description;
        
        // Render examples
        const examplesContainer = document.getElementById('modalExerciseExamples');
        examplesContainer.innerHTML = this.currentExercise.examples
            .map(example => `<div class="example-item">${example}</div>`)
            .join('');
        
        // Set starter code
        document.getElementById('exerciseEditor').value = this.currentExercise.starterCode;
        
        // Clear output
        document.getElementById('exerciseOutput').innerHTML = 
            '<div class="welcome-message">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–¥ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>';
        
        // Show modal
        document.getElementById('exerciseModal').classList.add('show');
    }

    setupModalEvents() {
        const modal = document.getElementById('exerciseModal');
        const closeBtn = modal.querySelector('.modal-close');

        closeBtn.addEventListener('click', () => {
            modal.classList.remove('show');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('show');
            }
        });
    }

    runExercise() {
        const code = document.getElementById('exerciseEditor').value;
        const output = document.getElementById('exerciseOutput');
        
        if (!code.trim()) {
            this.showOutput('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è', 'error');
            return;
        }

        this.showOutput('‚è≥ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞...', 'info');
        
        setTimeout(() => {
            try {
                const result = this.executePythonCode(code);
                this.showOutput(result, 'success');
            } catch (error) {
                this.showOutput(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }, 500);
    }

    executePythonCode(code) {
        // Enhanced code execution simulation
        let output = '';
        const lines = code.split('\n');
        
        // Simple execution simulation
        if (code.includes('def calculator')) {
            if (code.includes('return a + b') || code.includes('a + b')) {
                output = '8\n20\n2.0';
            } else {
                output = 'None\nNone\nNone';
            }
        } else if (code.includes('def check_even_odd')) {
            if (code.includes('number % 2 == 0')) {
                output = '–ß–µ—Ç–Ω–æ–µ\n–ù–µ—á–µ—Ç–Ω–æ–µ\n–ß–µ—Ç–Ω–æ–µ';
            } else {
                output = 'None\nNone\nNone';
            }
        } else {
            output = '–ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.';
        }
        
        return output;
    }

    resetExercise() {
        if (this.currentExercise) {
            document.getElementById('exerciseEditor').value = this.currentExercise.starterCode;
            this.showOutput('üîÑ –ö–æ–¥ —Å–±—Ä–æ—à–µ–Ω –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é', 'info');
        }
    }

    showHint() {
        if (!this.currentExercise) return;
        
        const hints = this.currentExercise.hints;
        const exerciseId = this.currentExercise.id;
        
        // Track hints usage
        if (!this.userProgress.hintsUsed[exerciseId]) {
            this.userProgress.hintsUsed[exerciseId] = 0;
        }
        
        const hintsUsed = this.userProgress.hintsUsed[exerciseId];
        
        if (hintsUsed < hints.length) {
            const hint = hints[hintsUsed];
            this.showOutput(`üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ ${hintsUsed + 1}: ${hint}`, 'info');
            this.userProgress.hintsUsed[exerciseId]++;
            this.saveUserProgress();
        } else {
            this.showOutput('üí° –í—Å–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã', 'warning');
        }
    }

    testExercise() {
        if (!this.currentExercise) return;
        
        const code = document.getElementById('exerciseEditor').value;
        const tests = this.currentExercise.tests;
        const output = document.getElementById('exerciseOutput');
        
        this.showOutput('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...', 'info');
        
        setTimeout(() => {
            let passed = 0;
            let results = [];
            
            tests.forEach((test, index) => {
                // Simplified test execution
                const isPassed = this.simulateTest(code, test);
                if (isPassed) passed++;
                
                results.push(
                    `–¢–µ—Å—Ç ${index + 1}: ${isPassed ? '‚úÖ –ü—Ä–æ–π–¥–µ–Ω' : '‚ùå –ù–µ –ø—Ä–æ–π–¥–µ–Ω'}`
                );
            });
            
            const successRate = Math.round((passed / tests.length) * 100);
            results.push(`\nüéØ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${passed}/${tests.length} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ (${successRate}%)`);
            
            if (passed === tests.length) {
                results.push('\nüéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!');
                this.markExerciseSolved(this.currentExercise.id);
            }
            
            this.showOutput(results.join('\n'), passed === tests.length ? 'success' : 'error');
        }, 1000);
    }

    simulateTest(code, test) {
        // Simplified test simulation
        if (this.currentExercise.id === 1) {
            // Calculator tests
            return code.includes('return a + b') && 
                   code.includes('return a * b') && 
                   code.includes('return a / b');
        } else if (this.currentExercise.id === 2) {
            // Even/odd tests
            return code.includes('number % 2 == 0') && 
                   code.includes('return "–ß–µ—Ç–Ω–æ–µ"') && 
                   code.includes('return "–ù–µ—á–µ—Ç–Ω–æ–µ"');
        }
        return false;
    }

    markExerciseSolved(exerciseId) {
        if (!this.userProgress.solved.includes(exerciseId)) {
            this.userProgress.solved.push(exerciseId);
            
            // Update streak
            const today = new Date().toDateString();
            if (this.userProgress.lastSolved !== today) {
                this.userProgress.currentStreak++;
                this.userProgress.lastSolved = today;
            }
            
            this.saveUserProgress();
            this.updateStats();
            this.renderExercises();
        }
    }

    showOutput(message, type = 'info') {
        const output = document.getElementById('exerciseOutput');
        const className = `output-${type}`;
        
        output.innerHTML = `<div class="${className}">${message}</div>`;
        output.scrollTop = output.scrollHeight;
    }

    updateStats() {
        const total = Object.keys(this.exercises).length;
        const solved = this.userProgress.solved.length;
        const successRate = total > 0 ? Math.round((solved / total) * 100) : 0;
        
        document.getElementById('totalExercises').textContent = total;
        document.getElementById('solvedExercises').textContent = solved;
        document.getElementById('successRate').textContent = `${successRate}%`;
        document.getElementById('currentStreak').textContent = this.userProgress.currentStreak;
        document.getElementById('solvedCount').textContent = `${solved}/${total}`;
        
        // Update progress bar
        const progressBar = document.getElementById('exercisesProgress');
        if (progressBar) {
            progressBar.style.width = `${successRate}%`;
        }
    }
}

// Initialize exercises manager
document.addEventListener('DOMContentLoaded', () => {
    window.exercisesManager = new ExercisesManager();
});
